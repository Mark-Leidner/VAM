c!#   $Id: compar.F,v 1.2 1997/02/12 19:19:28 leidner Exp $
c!#   $Log: compar.F,v $
c!#   Revision 1.2  1997/02/12 19:19:28  leidner
c!#   all include files changed to *.h
c!#
c!#	Revision 1.1  1997/02/10  16:39:08  leidner
c!#	Initial revision
c!#
      SUBROUTINE COMPAR
#include "vam.h"
C***********************************************************************
C*****COMPAR CALCULATES ALIASES FOR ANALYSIS AND FORECAST
C*****AND COMPARES RESULTS
C-----SPECIFICATIONS
C-----XREFS:
C-----USER : .BILIN ERRSEA IPGRID ...... ...... ...... ...... ......
C-----FORT : ...MOD FRDNL# FWRNL# IBCOM# ...... ...... ...... ......
#include "gparm.h"
#include "grdta.h"
#include "ptdta.h"
C-----COMMON BLOCK DESCRIBING WORK AREA WITH IDIM=IBF,IDIMY= JBF   MAY 8
      COMMON /WORK/ IC(IBF,JBF),idum(WBF-IBF*JBF)
C-----
      NAMELIST /CRIT/ ILINES,MLINES,IAGREE,IDISAG,IZERO,IFIXAL,IPLOT,
     +   LINCNT,IASUB
      DATA MLINES/100/,IZERO/0/,IFIXAL/0/,IPLOT/0/,LINCNT/80/,IASUB/0/
      REAL LAT,LONG
      ILINES=0
      IAGREE=0
      IDISAG=0
      DO 10 J=1,NY
      DO 10 I=1,NX
   10 IC(I,J)=0
      WRITE (6,101) NAME,NAME0
      WRITE (6,CRIT)
      READ (30,CRIT,END=1520,ERR=1520)
      WRITE (6,CRIT)
      IF (IASUB.EQ.1) WRITE (6,103)
  101 FORMAT ('0COMPARING CHOICES OF ALIASES BETWEEN ANALYSIS  ',
     +   A8,'  AND FIRST GUESS  ',A8)
  102 FORMAT ('0',33('====')/'     N NA   I   J     X     Y     LAT',
     +   '    LONG       W    U(M)    V(M)      UI      VI   U(M0)',
     +   '   V(M0)     U0I     V0I   DELV2  DELV02'/' ',33('----'))
  103 FORMAT ('0FIRST GUESS NOT USED. COMPARISON WITH FIRST ALIAS ',
     +   'WHICH IS THE ONE CHOSEN SUBJECTIVELY.')
      IF (NPTS.LE.0) CALL ERRSEA (513,6HCOMPAR)
C-----LOOP THROUGH POINTS
      DO 300 N=1,NPTS
      IF (WGT(N).LE.0) GO TO 300
      NA=NWINDS(N)
C-----ARE MULTILPLE ALIASES PRESENT
      IF (NA.GT.1) GO TO 30
      IF (IZERO.EQ.1) WGT(N)=-WGT(N)
      GO TO 300
C-----INTERPOLATE (U,V) GRID TO CURRENT LOCATION
   30 I=ILL(N)
      J=JLL(N)
      UI=BILIN (XCOORD(N),YCOORD(N),U(I,J),IDIM)
      VI=BILIN (XCOORD(N),YCOORD(N),V(I,J),IDIM)
C-----CALCULATE ALIAS CLOSEST TO (UI,VI)
      DELV2=(UI-UOBS(1,N))**2 + (VI-VOBS(1,N))**2
      M=1
C-----DETERMINE CLOSEST ALIAS
      DO 50 IA=2,NA
      D=(UI-UOBS(IA,N))**2 + (VI-VOBS(IA,N))**2
      IF (D.GT.DELV2) GO TO 50
      DELV2=D
      M=IA
   50 CONTINUE
C-----REPEAT ANALYSIS FOR (U0,V0)
C-----INTERPOLATE (U0,V0) GRID TO CURRENT LOCATION
      M0=1
      DELV02=0
      IF (IASUB.EQ.1) GO TO 175
      U0I=BILIN (XCOORD(N),YCOORD(N),U0(I,J),IDIM)
      V0I=BILIN (XCOORD(N),YCOORD(N),V0(I,J),IDIM)
C-----CALCULATE ALIAS CLOSEST TO (U0I,V0I)
      DELV02=(U0I-UOBS(1,N))**2 + (V0I-VOBS(1,N))**2
C-----DETERMINE CLOSEST ALIAS
      DO 150 IA=2,NA
      D=(U0I-UOBS(IA,N))**2 + (V0I-VOBS(IA,N))**2
      IF (D.GT.DELV02) GO TO 150
      DELV02=D
      M0=IA
  150 CONTINUE
C-----COMPARE
  175 IF (M.NE.M0) GO TO 200
      IAGREE=IAGREE+1
      IF (IZERO.EQ.1) WGT(N)=-WGT(N)
      IF (IFIXAL.NE.1) GO TO 300
C-----FIX THE ALIAS
      NWINDS(N)=1
      GO TO 275
  200 IDISAG=IDISAG+1
      IC(I,J)=IC(I,J)+1
      IF (ILINES .GE. MLINES) GO TO 250
C-----OUTPUT
      IF (MOD(ILINES,LINCNT).EQ.0) WRITE (6,102)
      LAT=YS+(J-1+YCOORD(N))*DELY
      LONG=XS+(I-1+XCOORD(N))*DELX
      WRITE (6,201) N,NA,I,J,XCOORD(N),YCOORD(N),LAT,LONG,WGT(N),
     +   UOBS(M,N),VOBS(M,N),UI,VI,UOBS(M0,N),VOBS(M0,N),U0I,V0I,
     +   DELV2,DELV02
  201 FORMAT (1H ,I5,I3,2I4,2F6.3,11F8.3,2F8.0)
      ILINES=ILINES+1
  250 IF (IZERO.EQ.-1) WGT(N)=-WGT(N)
      IF (IFIXAL.NE.1) GO TO 300
C-----FIX THE ALIASES
      NWINDS(N)=2
C-----FIRST SWITCH M AND 2
      IF (M.EQ.2) GO TO 275
      T=UOBS(2,N)
      UOBS(2,N)=UOBS(M,N)
      UOBS(M,N)=T
      T=VOBS(2,N)
      VOBS(2,N)=VOBS(M,N)
      VOBS(M,N)=T
      IF (M0.EQ.2) M0=M
C-----NOW SWITCH M0 AND 1
  275 IF (M0.EQ.1) GO TO 300
      T=UOBS(1,N)
      UOBS(1,N)=UOBS(M0,N)
      UOBS(M0,N)=T
      T=VOBS(1,N)
      VOBS(1,N)=VOBS(M0,N)
      VOBS(M0,N)=T
  300 CONTINUE
      WRITE (6,101) NAME,NAME0
      WRITE (6,CRIT)
      IF (IFIXAL.EQ.1) WRITE (6,303)
      IF (IZERO.EQ.1) WRITE (6,304)
      IF (IZERO.EQ.-1) WRITE (6,305)
  303 FORMAT ('0ALIASES NOT CLOSE TO EITHER FORECAST OR ANALYSIS GRID',
     +   ' ARE DISCARDED.')
  304 FORMAT ('0WEIGHTS OF POINTS WHERE ALIASES AGREE SET TO ZERO.')
  305 FORMAT ('0WEIGHTS OF POINTS WHERE ALIASES DISAGREE SET TO ZERO.')
      IF (IPLOT.NE.1) RETURN
      WRITE (6,302)
  302 FORMAT ('1DISTRIBUTION OF ALIASED WINDS DATA POINTS',
     +   ' WHICH DISAGREE'//)
      CALL IPGRID (IC(IP,JP),NIP,NJP,IDIM)
      RETURN
 1520 CALL ERRSEA (520,6HCOMPAR)
      RETURN
      END
