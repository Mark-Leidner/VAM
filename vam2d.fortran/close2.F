c!#   $Id: close2.F,v 1.2 1997/02/12 19:19:28 leidner Exp $
c!#   $Log: close2.F,v $
c!#   Revision 1.2  1997/02/12 19:19:28  leidner
c!#   all include files changed to *.h
c!#
c!#	Revision 1.1  1997/02/10  16:39:08  leidner
c!#	Initial revision
c!#
      SUBROUTINE CLOSE2
#include "vam.h"
C***********************************************************************
C*****CLOSE2 CALCULATES TWO CLOSEST ALIASES FOR ANALYSIS GRID
C*****AND COMPARES RESULTS
C-----THIS ROUTINE WORKS JUST LIKE SUBROUTINE COMPAR EXCEPT THAT
C-----THE TWO ALIAS CLOSEST TO THE ANALYSIS ARE COMPARED TO SEE
C-----IF THEY ARE EQUALLY GOOD ALTERNATIVES.
C-----SPECIFICATIONS
C-----XREFS:
C-----USER : .BILIN ERRSEA IPGRID ...... ...... ...... ...... ......
C-----FORT : ...ABS ...MOD FRDNL# FWRNL# IBCOM# ...... ...... ......
#include "gparm.h"
#include "grdta.h"
#include "ptdta.h"
C-----COMMON BLOCK DESCRIBING WORK AREA WITH IDIM=IBF,IDIMY= JBF   MAY 8
      COMMON /WORK/ IC(IBF,JBF),idum(WBF-IBF*JBF)
C-----DEFINE NUMERICAL CONSTANTS
      DATA FILL/-777D20/
C-----
      NAMELIST /CRIT/ ILINES,MLINES,IAGREE,IDISAG,IZERO,IFIXAL,IPLOT,
     +   GAMMA
      DATA MLINES/100/,IZERO/0/,IFIXAL/0/,IPLOT/0/,GAMMA/1D-1/
      REAL LAT,LONG
C     DOUBLE PRECISION ABS
C     ABS(DUMMY)=DABS(DUMMY)
      ILINES=0
      IAGREE=0
      IDISAG=0
      DO 10 J=1,NY
      DO 10 I=1,NX
   10 IC(I,J)=0
      WRITE (6,101) NAME
      WRITE (6,CRIT)
      READ (30,CRIT,END=1520,ERR=1520)
      WRITE (6,CRIT)
  101 FORMAT ('0COMPARING TWO CLOSEST ALIASES TO ANALYSIS  ',A8)
  102 FORMAT ('1    N NA   I   J     X     Y     LAT    LONG       W',
     +   '    U(M)    V(M)      UI      VI   U(M0)   V(M0)   DELV2',
     +   '  DELV02    TEST'/)
      IF (NPTS.LE.0) CALL ERRSEA (513,6H2CLOSE)
C-----LOOP THROUGH POINTS
      DO 300 N=1,NPTS
      IF (WGT(N).LE.0) GO TO 300
      NA=NWINDS(N)
C-----ARE MULTILPLE ALIASES PRESENT
      IF (NA.GT.1) GO TO 30
      IF (IZERO.EQ.1) WGT(N)=-WGT(N)
      GO TO 300
C-----INTERPOLATE (U,V) GRID TO CURRENT LOCATION
   30 I=ILL(N)
      J=JLL(N)
      UI=BILIN (XCOORD(N),YCOORD(N),U(I,J),IDIM)
      VI=BILIN (XCOORD(N),YCOORD(N),V(I,J),IDIM)
C-----CALCULATE ALIAS CLOSEST TO (UI,VI)
      DELV2=-2*FILL
      DELV02=-FILL
C-----DETERMINE TWO CLOSEST ALIASES
      DO 50 IA=1,NA
      D=(UI-UOBS(IA,N))**2 + (VI-VOBS(IA,N))**2
      IF (DELV02.GT.DELV2) GO TO 40
      IF (D.GT.DELV2) GO TO 50
      DELV2=D
      M=IA
      GO TO 50
   40 IF (D.GT.DELV02) GO TO 50
      DELV02=D
      M0=IA
   50 CONTINUE
C-----COMPARE - TEST FOR EXCEPTION
      IF ((DELV2+DELV02).LE.0) TEST=0
      IF ((DELV2+DELV02).GT.0) TEST=2*ABS(DELV2-DELV02)/(DELV2+DELV02)
      IF (TEST.LE.GAMMA) GO TO 200
      IAGREE=IAGREE+1
      IF (IZERO.EQ.1) WGT(N)=-WGT(N)
      IF (IFIXAL.NE.1) GO TO 300
      GO TO 265
  200 IDISAG=IDISAG+1
      IC(I,J)=IC(I,J)+1
      IF (ILINES .GE. MLINES) GO TO 250
C-----OUTPUT
      IF (MOD(ILINES,80).EQ.0) WRITE (6,102)
      LAT=YS+(J-1+YCOORD(N))*DELY
      LONG=XS+(I-1+XCOORD(N))*DELX
      WRITE (6,201) N,NA,I,J,XCOORD(N),YCOORD(N),LAT,LONG,WGT(N),
     +   UOBS(M,N),VOBS(M,N),UI,VI,UOBS(M0,N),VOBS(M0,N),
     +   DELV2,DELV02,TEST
  201 FORMAT (1H ,I5,I3,2I4,2F6.3,12F8.3)
      ILINES=ILINES+1
  250 IF (IZERO.EQ.-1) WGT(N)=-WGT(N)
      IF (IFIXAL.NE.1) GO TO 300
C-----FIX THE ALIASES
  265 NWINDS(N)=2
C-----FIRST SWITCH M0 AND 2
      IF (M0.EQ.2) GO TO 275
      T=UOBS(2,N)
      UOBS(2,N)=UOBS(M0,N)
      UOBS(M0,N)=T
      T=VOBS(2,N)
      VOBS(2,N)=VOBS(M0,N)
      VOBS(M0,N)=T
      IF (M.EQ.2) M=M0
C-----NOW SWITCH M AND 1
  275 IF (M.EQ.1) GO TO 300
      T=UOBS(1,N)
      UOBS(1,N)=UOBS(M,N)
      UOBS(M,N)=T
      T=VOBS(1,N)
      VOBS(1,N)=VOBS(M,N)
      VOBS(M,N)=T
  300 CONTINUE
      WRITE (6,101) NAME
      WRITE (6,CRIT)
      IF (IFIXAL.EQ.1) WRITE (6,303)
      IF (IZERO.EQ.1) WRITE (6,304)
      IF (IZERO.EQ.-1) WRITE (6,305)
  303 FORMAT ('0ALIASES NOT ONE OF TWO CLOSEST TO FORECAST GRID',
     +   ' ARE DISCARDED.')
  304 FORMAT ('0WEIGHTS OF POINTS WITH DISTINCT D-VALUES SET TO ZERO.')
  305 FORMAT ('0WEIGHTS OF POINTS WITH SIMILAR D-VALUES SET TO ZERO.')
      IF (IPLOT.NE.1) RETURN
      WRITE (6,302)
  302 FORMAT ('1DISTRIBUTION OF ALIASED WINDS DATA POINTS',
     +   ' WITH SIMILAR D-VALUES'//)
      CALL IPGRID (IC(IP,JP),NIP,NJP,IDIM)
      RETURN
 1520 CALL ERRSEA (520,6H2CLOSE)
      RETURN
      END
